<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI 对话窗口</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .chat-container { max-width: 800px; margin: 40px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #messages { height: 450px; border: 1px solid #dee2e6; padding: 15px; overflow-y: auto; margin-bottom: 15px; background-color: #e9ecef; border-radius: 6px; }
        .message { padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; max-width: 80%; }
        .user-msg { background-color: #0d6efd; color: white; margin-left: auto; text-align: right; }
        .ai-msg { background-color: #e2e6ea; color: #212529; margin-right: auto; text-align: left; }
    </style>
</head>
<body>
    <div class="container chat-container">
        <h1 class="mb-4 text-center">AI 对话助手</h1>
        <p class="text-end text-muted"><a href="/admin.html" class="text-decoration-none">管理后台 &gt;</a></p>
        
        <div id="messages"></div>
        
        <div class="input-group">
            <input type="text" id="userInput" class="form-control" placeholder="输入您的问题..." aria-label="用户输入">
            <button class="btn btn-primary" type="button" onclick="sendMessage()" id="sendButton">
                发送
            </button>
        </div>
    </div>

    <script>
        const messagesElement = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        function displayMessage(sender, text, className) {
            const wrapper = document.createElement('div');
            wrapper.className = `d-flex ${sender === '您' ? 'justify-content-end' : 'justify-content-start'}`;

            const p = document.createElement('div');
            p.className = `message ${className}`;
            p.innerHTML = text;
            
            wrapper.appendChild(p);
            messagesElement.appendChild(wrapper);
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        // 1. 加载欢迎语 (调用 /api/config 接口)
        async function loadWelcomeMessage() {
            try {
                const response = await fetch('/api/config'); 
                
                if (response.ok) {
                    const config = await response.json();
                    displayMessage('AI', config.welcomeMessage, 'ai-msg'); 
                } else {
                    displayMessage('AI', "欢迎！AI 接口配置尚未加载，请访问管理后台配置。", 'ai-msg');
                }
            } catch (e) {
                displayMessage('AI', "欢迎语加载网络错误。", 'ai-msg');
            }
        }

        // 2. 发送对话消息
        async function sendMessage() {
            const message = userInput.value;
            if (!message.trim()) return;

            displayMessage('您', message, 'user-msg');
            userInput.value = '';
            sendButton.disabled = true;
            sendButton.textContent = '思考中...';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // ***** 关键修改部分：Gemini API 请求体 *****
                    body: JSON.stringify({
                        // Gemini 使用 'contents' 数组，里面是 role/parts 结构
                        contents: [{ role: "user", parts: [{ text: message }] }]
                    }) 
                    // *************************************
                });

                if (response.ok) {
                    const data = await response.json();
                    // 解析 Gemini API 响应结构
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "（AI响应解析失败）";
                    displayMessage('AI', aiText, 'ai-msg');
                } else {
                    const errorData = await response.json().catch(() => ({error: response.statusText})); 
                    displayMessage('AI', `错误: ${response.status} - ${errorData.error || response.statusText}`, 'ai-msg');
                }
            } catch (error) {
                displayMessage('AI', `网络错误: 无法连接到服务器。`, 'ai-msg');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = '发送';
            }
        }

        loadWelcomeMessage();
    </script>
</body>
</html>
