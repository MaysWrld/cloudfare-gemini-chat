<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">

    <style>
        /* CSS variables for dark/light theme */
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --chat-bg-user: #e2f1ff;
            --chat-bg-ai: #ffffff;
            --input-bg: #ffffff;
            --border-color: #ced4da;
            --link-color: #0d6efd;
        }
        
        /* Dark mode preference */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #212529;
                --text-color: #f8f9fa;
                --chat-bg-user: #3a4750;
                --chat-bg-ai: #2c353d;
                --input-bg: #343a40;
                --border-color: #495057;
                --link-color: #8ab4f8;
            }
            .chat-message { color: var(--text-color); }
            .list-group-item { background-color: var(--chat-bg-ai) !important; border-color: var(--border-color); }
            .form-control, .btn-primary { color: var(--text-color); background-color: var(--input-bg); border-color: var(--border-color); }
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            /* ğŸ“Œ å…³é”®ä¿®å¤ 1: ç¡®ä¿ body å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ï¼Œä¸”ä¸ä¼šå› ä¸ºå†…å®¹æº¢å‡ºè€Œæ»šåŠ¨ */
            height: 100vh; 
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        
        /* å®¹å™¨è°ƒæ•´ */
        .container-fluid {
            height: 100%; 
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            /* ğŸ“Œ å…³é”®ä¿®å¤ 2: ä½¿ç”¨ flex-basis: 0; ç¡®ä¿åœ¨ flex å®¹å™¨ä¸­æ­£ç¡®è®¡ç®—é«˜åº¦ */
            flex-basis: 0; 
            overflow: hidden; 
            padding-top: 0; 
            padding-bottom: 20px;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }

        .chat-history {
            flex-grow: 1;
            /* ğŸ“Œ å…³é”®ä¿®å¤ 3: å…è®¸èŠå¤©è®°å½•åŒºåŸŸæ»šåŠ¨ */
            overflow-y: auto; 
            padding: 0 10px;
        }
        
        /* æ¶ˆæ¯æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
        .chat-message { margin-bottom: 15px; border-radius: 12px; padding: 10px 15px; max-width: 90%; word-wrap: break-word; position: relative; }
        .user-message { background-color: var(--chat-bg-user); margin-left: auto; border-bottom-right-radius: 4px; }
        .ai-message { background-color: var(--chat-bg-ai); margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        
        /* å¤´éƒ¨å’Œè¾“å…¥åŒºï¼ˆä¿æŒä¸å˜ï¼‰ */
        .chat-header { background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); padding: 10px 15px; position: sticky; top: 0; z-index: 10; }
        .chat-input-area { background-color: var(--background-color); padding: 10px 0; max-width: 900px; width: 100%; margin: 0 auto; }
        
        /* åŠ è½½åŠ¨ç”»æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
        #typingIndicatorContainer { background-color: var(--background-color); padding: 0 10px; display: flex; justify-content: center; align-items: center; height: 30px; width: 100%; max-width: 900px; margin: 0 auto; }
        #typingIndicator { font-size: 0.75em; color: #6c757d; display: flex; align-items: center; }
        #typingIndicator > .chat-message { background: none !important; border: none !important; padding: 0; margin: 0; }

        /* ... çœç•¥ä»£ç å—/è¡¨æ ¼æ ·å¼ ... */
    </style>
</head>
<body>
    <div class="container-fluid d-flex flex-column h-100 p-0">
        
        <div class="chat-header text-center">
            <h5 id="appTitle">AI Chat</h5>
            <button id="newChatButton" class="btn btn-sm btn-outline-secondary position-absolute top-50 start-0 translate-middle-y ms-2">
                æ–°å»ºèŠå¤©
            </button>
        </div>
        
        <div id="typingIndicatorContainer" style="display: none;">
             <div id="typingIndicator">
                <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                AI æ­£åœ¨æ€è€ƒ...
            </div>
        </div>

        <div class="chat-container">
            <div id="chatHistory" class="chat-history">
                <div class="d-flex justify-content-start">
                    <div id="welcomeMessage" class="chat-message ai-message">
                        æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹ï¼
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area mt-auto">
                <form id="chatForm" class="input-group">
                    <textarea id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)" rows="1" required></textarea>
                    <button type="submit" id="sendButton" class="btn btn-primary" style="width: 80px;">å‘é€</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const typingIndicatorContainer = document.getElementById('typingIndicatorContainer');
        const newChatButton = document.getElementById('newChatButton');
        
        let currentAbortController = null;
        let isSending = false;
        let typingInterval = null;
        let currentMessageElement = null;
        let isComposing = false;

        // =======================================================
        // UI & RENDERING FUNCTIONS
        // =======================================================
        
        function scrollHistoryToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ç§»åŠ¨ç«¯è¾“å…¥æ³•æå‡ä¼˜åŒ–
        function handleFocusScroll() {
            // å»¶è¿Ÿæ»šåŠ¨ï¼Œç­‰å¾…ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡ºå®Œæˆ
            setTimeout(() => {
                scrollHistoryToBottom();
            }, 300); 
        }
        messageInput.addEventListener('focus', handleFocusScroll);
        
        // ... (renderMarkdown, createMessageElement, stopAllTyping ä¿æŒä¸å˜) ...
        function renderMarkdown(element, markdownText) {
            let html = markdownText
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');      
            
            const codeBlocks = [];
            html = html.replace(/```(\w+)?\s*([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang ? lang.trim() : 'plaintext';
                codeBlocks.push({ language, code: code.trim() }); 
                return `[CODE_BLOCK_${codeBlocks.length - 1}]`;
            });
            
            html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>');
            
            element.innerHTML = html;

            codeBlocks.forEach((block, index) => {
                const placeholder = `[CODE_BLOCK_${index}]`;
                const tempDiv = document.createElement('div');
                tempDiv.innerText = block.code;
                
                const pre = document.createElement('pre');
                const header = document.createElement('div');
                header.className = 'code-header';
                header.innerHTML = `<span>${block.language.toUpperCase()}</span><button class="copy-btn" data-code-id="${index}">å¤åˆ¶</button>`;
                const codeElement = document.createElement('code');
                codeElement.className = `language-${block.language}`;
                codeElement.textContent = block.code;
                
                hljs.highlightElement(codeElement);
                
                pre.appendChild(header);
                pre.appendChild(codeElement);
                
                const currentHtml = element.innerHTML;
                element.innerHTML = currentHtml.replace(placeholder, pre.outerHTML);
            });

            setTimeout(() => {
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.onclick = async () => {
                        const codeId = button.getAttribute('data-code-id');
                        const code = codeBlocks[parseInt(codeId)].code;
                        try {
                            await navigator.clipboard.writeText(code);
                            button.textContent = 'å·²å¤åˆ¶!';
                            setTimeout(() => { button.textContent = 'å¤åˆ¶'; }, 2000);
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            button.textContent = 'å¤åˆ¶å¤±è´¥';
                        }
                    };
                });
            }, 0);
        }

        function createMessageElement(role) {
            const wrapper = document.createElement('div');
            wrapper.className = `d-flex ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            messageDiv.innerHTML = role === 'user' ? messageInput.value : '';
            
            wrapper.appendChild(messageDiv);
            chatHistory.appendChild(wrapper);
            
            return messageDiv;
        }

        function stopAllTyping() {
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            if (currentMessageElement) {
                currentMessageElement.classList.remove('typing'); 
            }
        }

        // =======================================================
        // CORE CHAT FUNCTIONS
        // =======================================================
        
        async function handleApiChat(message) {
            stopAllTyping();
            isSending = true;
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            typingIndicatorContainer.style.display = 'flex'; 
            scrollHistoryToBottom();

            currentAbortController = new AbortController();
            let aiText = '';

            try {
                createMessageElement('user');
                messageInput.value = '';
                
                currentMessageElement = createMessageElement('ai');
                currentMessageElement.classList.add('typing');
                scrollHistoryToBottom();

                const contents = [{ role: "user", parts: [{ text: message }] }];

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents }),
                    signal: currentAbortController.signal
                });

                typingIndicatorContainer.style.display = 'none';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `AI æ¥å£é”™è¯¯: çŠ¶æ€ç  ${response.status}`);
                }

                const data = await response.json();
                aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'AI è¿”å›äº†ç©ºå†…å®¹ã€‚';
                
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < aiText.length) {
                        currentMessageElement.textContent = aiText.substring(0, i + 1); 
                        i++;
                        scrollHistoryToBottom();
                    } else {
                        stopAllTyping();
                        renderMarkdown(currentMessageElement, aiText);
                        scrollHistoryToBottom();
                    }
                }, 25); 

            } catch (error) {
                if (error.name !== 'AbortError') {
                    typingIndicatorContainer.style.display = 'none'; 
                    stopAllTyping();
                    const errorMessage = error.message.includes('AI æ¥å£é”™è¯¯') ? error.message : `ç½‘ç»œ/ç³»ç»Ÿé”™è¯¯: ${error.message}`;
                    currentMessageElement.textContent = errorMessage; 
                    currentMessageElement.style.color = 'red';
                    console.error('Chat Error:', error);
                }
            } finally {
                const checkTyping = setInterval(() => {
                    if (!typingInterval) {
                        isSending = false;
                        sendButton.disabled = false;
                        messageInput.disabled = false;
                        typingIndicatorContainer.style.display = 'none'; 
                        clearInterval(checkTyping);
                    }
                }, 100);
            }
        }

        // =======================================================
        // INITIALIZATION & EVENTS
        // =======================================================
        
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
            scrollHistoryToBottom();
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && !isSending) {
                handleApiChat(message);
            }
        });

        messageInput.addEventListener('compositionstart', () => { isComposing = true; });
        messageInput.addEventListener('compositionend', () => { isComposing = false; });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (isComposing) {
                    return; 
                }
                e.preventDefault(); 
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        newChatButton.addEventListener('click', startNewChat);

        // ğŸ“Œ å…³é”®ä¿®å¤ 4: ç¡®ä¿é…ç½®åŠ è½½æˆåŠŸæˆ–å¤±è´¥éƒ½èƒ½å¤„ç†
        async function fetchConfig() {
            try {
                const response = await fetch('/api/admin');
                if (response.ok) {
                    const config = await response.json();
                    
                    const appTitle = config.appTitle || 'AI Chat';
                    const welcomeMessage = config.welcomeMessage || 'æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹ï¼';
                    
                    document.title = appTitle;
                    document.getElementById('appTitle').textContent = appTitle;
                    welcomeMessageElement.textContent = welcomeMessage;
                }
            } catch (error) {
                console.warn('Failed to fetch config (Network Error):', error);
                // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸é˜»å¡é¡µé¢
            }
            
            // ç¡®ä¿åœ¨åˆå§‹åŒ–ç»“æŸæ—¶å¼ºåˆ¶éšè—åŠ è½½åŠ¨ç”»
            typingIndicatorContainer.style.display = 'none'; 
            
            // ğŸ“Œ å…³é”®ä¿®å¤ 5: ç¡®ä¿åˆå§‹æ»šåŠ¨åˆ°æ¬¢è¿è¯­ï¼Œç‰¹åˆ«æ˜¯åœ¨ç§»åŠ¨ç«¯
            scrollHistoryToBottom(); 
        }

        // --- New Chat Function (ä¿æŒä¸å˜) ---
        async function startNewChat() {
            if (!confirm("ç¡®å®šè¦å¼€å¯æ–°çš„èŠå¤©å—ï¼Ÿå½“å‰å¯¹è¯è®°å½•å°†è¢«æ¸…ç©ºã€‚")) {
                return;
            }
            try {
                stopAllTyping();
                if (currentAbortController) {
                    currentAbortController.abort();
                }
                // ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
                newChatButton.disabled = true; 
                
                const response = await fetch('/api/new_chat', { method: 'POST' });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('æ¸…é™¤å†å²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯é…ç½®ã€‚');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æ¸…é™¤ä¼šè¯æ¥å£ã€‚');
                console.error('New Chat Error:', error);
            } finally {
                // ç¡®ä¿æ— è®ºæˆåŠŸå¤±è´¥ï¼ŒæŒ‰é’®éƒ½ä¼šåœ¨æ“ä½œç»“æŸåæ¢å¤ï¼ˆé™¤äº†æˆåŠŸåé¡µé¢ä¼šåˆ·æ–°ï¼‰
                newChatButton.disabled = false;
            }
        }

        fetchConfig();
    </script>
</body>
</html>
