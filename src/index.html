<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">

    <style>
        /* CSS variables for dark/light theme */
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --chat-bg-user: #e2f1ff;
            --chat-bg-ai: #ffffff;
            --input-bg: #ffffff;
            --border-color: #ced4da;
            --link-color: #0d6efd;
        }
        
        /* Dark mode preference */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #212529;
                --text-color: #f8f9fa;
                --chat-bg-user: #3a4750; /* Slightly darker blue-grey for user */
                --chat-bg-ai: #2c353d; /* Darker grey for AI */
                --input-bg: #343a40;
                --border-color: #495057;
                --link-color: #8ab4f8; /* Light blue for links */
            }
            .chat-message {
                color: var(--text-color);
            }
            .list-group-item {
                background-color: var(--chat-bg-ai) !important;
                border-color: var(--border-color);
            }
            .form-control, .btn-primary {
                color: var(--text-color);
                background-color: var(--input-bg);
                border-color: var(--border-color);
            }
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* --- å“åº”å¼å¸ƒå±€ä¼˜åŒ– (æ­¥éª¤ä¸‰) --- */
        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: hidden;
            padding-top: 20px;
            padding-bottom: 20px;
            /* ç¡®ä¿åœ¨æå®½å±å¹•ä¸Šå±…ä¸­ä¸”æœ‰æœ€å¤§å®½åº¦ */
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            border-radius: 12px;
            padding: 10px 15px;
            max-width: 90%;
            word-wrap: break-word;
            position: relative; /* For the typing cursor */
        }

        .user-message {
            background-color: var(--chat-bg-user);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: var(--chat-bg-ai);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            /* ç¡®ä¿ AI æ¶ˆæ¯çš„å®½åº¦é€‚åº”å†…å®¹ï¼Œä½†åœ¨ dark mode ä¸‹å¯è§ */
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background-color: var(--input-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .chat-input-area {
            background-color: var(--background-color);
            padding: 10px 0;
            /* ç¡®ä¿è¾“å…¥åŒºåœ¨æå®½å±å¹•ä¸Šå’ŒèŠå¤©å®¹å™¨å¯¹é½ */
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }

        /* --- ä»£ç å—ä¼˜åŒ– (æ­¥éª¤ä¸€) --- */
        .ai-message pre {
            position: relative;
            background-color: #272822 !important; /* Monokai background */
            padding-top: 35px; /* Space for the header */
            border-radius: 6px;
        }

        .code-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background-color: #333;
            color: #ccc;
            padding: 5px 10px;
            font-size: 0.8em;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 0 10px;
            font-size: 0.9em;
        }
        
        .copy-btn:hover {
            color: white;
        }

        .hljs {
            display: block;
            overflow-x: auto;
            padding: 1em;
            /* ç§»é™¤ highlight.js é»˜è®¤çš„ backgroundï¼Œç”± pre æ ‡ç­¾æ§åˆ¶ */
            background: none !important; 
        }

        /* ğŸ“Œ æ–°å¢ï¼šè¡¨æ ¼æ ·å¼ (æ­¥éª¤ä¸€) */
        .ai-message table {
            width: 100%;
            margin: 1em 0;
            border-collapse: collapse;
        }

        .ai-message th, .ai-message td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .ai-message th {
            background-color: var(--input-bg);
            font-weight: bold;
        }
        
        /* ğŸ“Œ æ–°å¢ï¼šæ‰“å­—å…‰æ ‡ */
        .typing::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent; }
            50% { color: var(--text-color); }
        }
    </style>
</head>
<body>
    <div class="container-fluid d-flex flex-column h-100 p-0">
        
        <div class="chat-header text-center">
            <h5 id="appTitle">AI Chat</h5>
            <button id="newChatButton" class="btn btn-sm btn-outline-secondary position-absolute top-50 start-0 translate-middle-y ms-2">
                æ–°å»ºèŠå¤©
            </button>
        </div>

        <div class="chat-container">
            <div id="chatHistory" class="chat-history">
                <div class="d-flex justify-content-start">
                    <div id="welcomeMessage" class="chat-message ai-message">
                        æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹ï¼
                    </div>
                </div>
                
                <div id="typingIndicator" class="d-flex justify-content-start" style="display: none;">
                    <div class="chat-message ai-message">
                        <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                        <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                        AI æ­£åœ¨æ€è€ƒ...
                    </div>
                </div>
                
            </div>
            
            <div class="chat-input-area mt-auto">
                <form id="chatForm" class="input-group">
                    <textarea id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)" rows="1" required></textarea>
                    <button type="submit" id="sendButton" class="btn btn-primary" style="width: 80px;">å‘é€</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const typingIndicator = document.getElementById('typingIndicator');
        const newChatButton = document.getElementById('newChatButton');
        
        let currentAbortController = null;
        let isSending = false;
        let typingInterval = null;
        let currentMessageElement = null;

        // =======================================================
        // UI & RENDERING FUNCTIONS
        // =======================================================

        // ğŸ“Œ æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šæ”¯æŒ Markdownã€è¡¨æ ¼ã€ä»£ç é«˜äº®å’Œå¤åˆ¶
        function renderMarkdown(element, markdownText) {
            // 1. åŸºæœ¬ Markdown è½¬æ¢ï¼ˆç®€å•å®ç°ï¼Œä¸å¼•å…¥é‡å‹åº“ï¼‰
            let html = markdownText
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '<br><br>') // ä¿æŒæ®µè½é—´è·
                .replace(/\n/g, '<br>');      // ç®€å•æ¢è¡Œ
            
            // 2. ä¸´æ—¶å ä½ç¬¦æ›¿æ¢ä»£ç å—ï¼Œé˜²æ­¢ Markdown å½±å“ä»£ç å†…å®¹
            const codeBlocks = [];
            html = html.replace(/```(\w+)?\s*([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang ? lang.trim() : 'plaintext';
                // å­˜å‚¨ä»£ç å—çš„åŸå§‹æ•°æ®å’Œè¯­è¨€
                codeBlocks.push({ language, code: code.trim() }); 
                return `[CODE_BLOCK_${codeBlocks.length - 1}]`;
            });
            
            // 3. å†æ¬¡è¿›è¡Œåˆ—è¡¨å’Œæ®µè½å¤„ç†
            html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>');
            
            element.innerHTML = html;

            // 4. æ¢å¤ä»£ç å—å¹¶åº”ç”¨é«˜äº®
            codeBlocks.forEach((block, index) => {
                const placeholder = `[CODE_BLOCK_${index}]`;
                const tempDiv = document.createElement('div');
                tempDiv.innerText = block.code; // ä½¿ç”¨ innerText è·å–åŸå§‹å†…å®¹
                
                // åˆ›å»º pre å…ƒç´ 
                const pre = document.createElement('pre');
                
                // åˆ›å»º header
                const header = document.createElement('div');
                header.className = 'code-header';
                header.innerHTML = `<span>${block.language.toUpperCase()}</span><button class="copy-btn" data-code-id="${index}">å¤åˆ¶</button>`;
                
                // åˆ›å»º code å…ƒç´ å¹¶åº”ç”¨é«˜äº®
                const codeElement = document.createElement('code');
                codeElement.className = `language-${block.language}`;
                codeElement.textContent = block.code;
                
                // è¿è¡Œ highlight.js
                hljs.highlightElement(codeElement);
                
                pre.appendChild(header);
                pre.appendChild(codeElement);
                
                // å°†ä»£ç å—æ’å…¥åˆ° HTML ä¸­
                const currentHtml = element.innerHTML;
                element.innerHTML = currentHtml.replace(placeholder, pre.outerHTML);
            });

            // 5. ç»‘å®šå¤åˆ¶äº‹ä»¶ï¼ˆéœ€è¦å»¶è¿Ÿæ‰§è¡Œï¼Œå› ä¸ºä»£ç å—æ˜¯åŠ¨æ€æ’å…¥çš„ï¼‰
            setTimeout(() => {
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.onclick = async () => {
                        const codeId = button.getAttribute('data-code-id');
                        const code = codeBlocks[parseInt(codeId)].code;
                        try {
                            await navigator.clipboard.writeText(code);
                            button.textContent = 'å·²å¤åˆ¶!';
                            setTimeout(() => { button.textContent = 'å¤åˆ¶'; }, 2000);
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            button.textContent = 'å¤åˆ¶å¤±è´¥';
                        }
                    };
                });
            }, 0);
        }
        
        function scrollHistoryToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // =======================================================
        // CORE CHAT FUNCTIONS
        // =======================================================

        function createMessageElement(role) {
            const wrapper = document.createElement('div');
            wrapper.className = `d-flex ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            messageDiv.innerHTML = role === 'user' ? messageInput.value : '';
            
            wrapper.appendChild(messageDiv);
            chatHistory.appendChild(wrapper);
            
            return messageDiv;
        }

        function stopAllTyping() {
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            if (currentMessageElement) {
                // ç§»é™¤æ‰“å­—å…‰æ ‡
                currentMessageElement.classList.remove('typing'); 
            }
        }
        
        async function handleApiChat(message) {
            // çŠ¶æ€æ§åˆ¶
            stopAllTyping();
            isSending = true;
            sendButton.disabled = true;
            messageInput.disabled = true;
            typingIndicator.style.display = 'flex';
            scrollHistoryToBottom();

            currentAbortController = new AbortController();
            let aiText = '';

            try {
                // 1. åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å…ƒç´ 
                createMessageElement('user');
                messageInput.value = '';
                
                // 2. åˆ›å»º AI æ¶ˆæ¯å…ƒç´ å¹¶è®¾ç½®ä¸ºå½“å‰æ‰“å­—ç›®æ ‡
                currentMessageElement = createMessageElement('ai');
                currentMessageElement.classList.add('typing'); // æ·»åŠ æ‰“å­—å…‰æ ‡
                scrollHistoryToBottom();

                // 3. æ„å»ºè¯·æ±‚ä½“ (å†å²è®°å½•åœ¨ Worker ä¸­å¤„ç†)
                const contents = [{ role: "user", parts: [{ text: message }] }];

                // 4. å‘é€è¯·æ±‚
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents }),
                    signal: currentAbortController.signal
                });

                typingIndicator.style.display = 'none';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `AI æ¥å£é”™è¯¯: çŠ¶æ€ç  ${response.status}`);
                }

                const data = await response.json();
                aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'AI è¿”å›äº†ç©ºå†…å®¹ã€‚';
                
                // 5. ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤º AI æ–‡æœ¬
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < aiText.length) {
                        // ä½¿ç”¨ substring ä»£æ›¿ç›´æ¥ç´¯åŠ ï¼Œæ€§èƒ½æ›´å¥½
                        currentMessageElement.textContent = aiText.substring(0, i + 1); 
                        i++;
                        scrollHistoryToBottom();
                    } else {
                        // 6. æ¸²æŸ“æœ€ç»ˆçš„ Markdown/é«˜äº®
                        stopAllTyping();
                        renderMarkdown(currentMessageElement, aiText);
                        scrollHistoryToBottom();
                    }
                }, 25); // è°ƒæ•´æ‰“å­—é€Ÿåº¦

            } catch (error) {
                if (error.name !== 'AbortError') {
                    typingIndicator.style.display = 'none';
                    stopAllTyping();
                    const errorMessage = error.message.includes('AI æ¥å£é”™è¯¯') ? error.message : `ç½‘ç»œ/ç³»ç»Ÿé”™è¯¯: ${error.message}`;
                    // åœ¨ AI æ¶ˆæ¯åŒºåŸŸæ˜¾ç¤ºé”™è¯¯
                    currentMessageElement.textContent = errorMessage; 
                    currentMessageElement.style.color = 'red';
                    console.error('Chat Error:', error);
                }
            } finally {
                // ç­‰å¾…æ‰“å­—æœºæ•ˆæœç»“æŸåå†è§£é”è¾“å…¥
                const checkTyping = setInterval(() => {
                    if (!typingInterval) {
                        isSending = false;
                        sendButton.disabled = false;
                        messageInput.disabled = false;
                        clearInterval(checkTyping);
                    }
                }, 100);
            }
        }

        // =======================================================
        // INITIALIZATION & EVENTS
        // =======================================================
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && !isSending) {
                handleApiChat(message);
            }
        });

        // Shift+Enter æ¢è¡Œï¼ŒEnter å‘é€
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        newChatButton.addEventListener('click', startNewChat);

        // å¼‚æ­¥åŠ è½½é…ç½®
        async function fetchConfig() {
            try {
                const response = await fetch('/api/admin');
                if (response.ok) {
                    const config = await response.json();
                    document.title = config.appTitle || 'AI Chat';
                    document.getElementById('appTitle').textContent = config.appTitle || 'AI Chat';
                    welcomeMessageElement.textContent = config.welcomeMessage || 'æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹ï¼';
                }
            } catch (error) {
                console.warn('Failed to fetch config:', error);
            }
        }

        // --- New Chat Function (As previously provided) ---
        async function startNewChat() {
            if (!confirm("ç¡®å®šè¦å¼€å¯æ–°çš„èŠå¤©å—ï¼Ÿå½“å‰å¯¹è¯è®°å½•å°†è¢«æ¸…ç©ºã€‚")) {
                return;
            }

            try {
                stopAllTyping();
                if (currentAbortController) {
                    currentAbortController.abort();
                }

                const response = await fetch('/api/new_chat', { method: 'POST' });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('æ¸…é™¤å†å²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯é…ç½®ã€‚');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æ¸…é™¤ä¼šè¯æ¥å£ã€‚');
                console.error('New Chat Error:', error);
            }
        }

        fetchConfig();
        scrollHistoryToBottom();
    </script>
</body>
</html>
