<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI 配置管理</title>
    <style>
        /* 简洁样式，确保可读性 */
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; line-height: 1.6; }
        input[type="text"], input[type="url"] { width: 100%; padding: 8px; margin: 6px 0 16px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        #status { padding: 10px; margin-bottom: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>AI 配置管理</h1>
    <div id="status" style="background-color: #e6ffe6; color: #006400;">请使用浏览器弹出的登录框输入管理员凭证。</div>
    
    <form id="configForm">
        <label for="apiUrl">AI API 接口 URL:</label>
        <input type="url" id="apiUrl" name="apiUrl" required>
        
        <label for="apiKey">AI API Key (密钥):</label>
        <input type="text" id="apiKey" name="apiKey" required>
        
        <label for="welcomeMessage">对话欢迎语:</label>
        <input type="text" id="welcomeMessage" name="welcomeMessage" required>
        
        <button type="submit">保存配置</button>
    </form>

    <script>
        const statusElement = document.getElementById('status');
        const form = document.getElementById('configForm');
        
        // 1. 加载现有配置 (通过 GET 请求 /api/admin)
        async function loadConfig() {
            try {
                // 浏览器看到 401 会自动弹出 Basic Auth 登录框
                const response = await fetch('/api/admin'); 
                
                if (response.status === 401) {
                    statusElement.textContent = '认证失败。请刷新页面重新输入凭证。';
                    return;
                }

                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('apiUrl').value = config.apiUrl || '';
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('welcomeMessage').value = config.welcomeMessage || '';
                    statusElement.textContent = '配置加载成功。';
                } else {
                    statusElement.textContent = `加载配置失败，状态码: ${response.status}`;
                }
            } catch (error) {
                statusElement.textContent = '网络请求错误。';
            }
        }

        // 2. 提交新配置 (通过 POST 请求 /api/admin)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                apiUrl: document.getElementById('apiUrl').value,
                apiKey: document.getElementById('apiKey').value,
                welcomeMessage: document.getElementById('welcomeMessage').value
            };
            
            try {
                // POST 请求会自动带上已登录的 Basic Auth 凭证
                const response = await fetch('/api/admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();

                if (response.ok) {
                    statusElement.style.backgroundColor = '#e6ffe6';
                    statusElement.style.color = '#006400';
                    statusElement.textContent = result.message;
                } else {
                    statusElement.style.backgroundColor = '#ffe6e6';
                    statusElement.style.color = '#cc0000';
                    statusElement.textContent = `保存失败: ${result.error || response.statusText}`;
                }
            } catch (error) {
                statusElement.textContent = '保存时发生网络错误。';
            }
        });

        loadConfig();
    </script>
</body>
</html>
